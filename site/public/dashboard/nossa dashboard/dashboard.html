<!DOCTYPE html>
<html lang="pt">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <link rel="stylesheet" href="dashboard.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp" rel="stylesheet">
  <!-- IMPORTANDO ICONES DO GOOGLE -->

  <script type="text/javascript" src="https://www.chartjs.org/dist/2.8.0/Chart.min.js"></script>

</head>

<body>
  <!-- COMEÇO DA NAVBAR  -->
  <nav>
    <div class="container">
      <img src="images/LogoMATprojetoOrange.png" alt="" class="logo">
      <div class="search-bar">
        <span class="material-icons-sharp">search</span>
        <input type="search" placeholder="Buscar...">
      </div>

      <div class="comboBox">


        <select id="lista_estacionamento">
          <option value="">Morumbi</option>
          <option value="">Consolação</option>
          <option value="">Tatuapé</option>
          <option value="">Penha</option>
          <option value="">Faria Lima</option>
        </select>
        <span class="material-icons-sharp"> expand_more</span>
      </div>


      <div class="adm">

        <span class="nome">Bem-vindo, Fernando!</span>
      </div>

      <!-- <button id="menu-btn">
                <span class="material-icons-sharp">menu</span>
            </button> -->

    </div>
  </nav>
  <!-- FIM DA NAVBAR  -->
  <main>
    <!--============================== COMEÇO BARRA LATERAL - MENU =============================================== -->

    <aside>
      <!-- TAG UTILIZADA PARA CRIAR UMA BARRA LATERAL, NO CASO O MENU  -->
      <div class="sidebar">
        <div class="logo-details">

          <div class="logo_name">MAT</div>
          <i class='bx bx-menu' id="btn"></i>
        </div>
        <ul class="nav-list">
          <li>
            <i class='bx bx-search'></i>
            <input type="text" placeholder="Search...">
            <span class="tooltip">Pesquisar</span>
          </li>
          <li>
            <a href="dashboard.html">
              <i class='bx bx-grid-alt'></i>
              <span class="links_name">Dashboard</span>
            </a>
            <span class="tooltip">Dashboard</span>
          </li>
          <li>

          <li>
            <a href="#">
              <i class='bx bx-car'></i>
              <span class="links_name">Estacionamento</span>
            </a>
            <span class="tooltip">Estacionamento</span>
          </li>
          <li>

            <a href="alertas.html">
              <i class='bx bx-pie-chart-alt-2'></i>
              <span class="links_name">Analytics</span>
            </a>
            <span class="tooltip">Analytics</span>
          </li>

          <li>

            <a href="https://mat-suporte.freshdesk.com/support/home">
              <i class='bx bx-support'></i>
              <span class="links_name">Suporte</span>
            </a>
            <span class="tooltip">
              Support</span>
          </li>



          <li>

          <li class="profile">
            <div class="profile-details">

              <div class="name_job">
                <div class="name">Fernando</div>
                <div class="job">Administrador</div>
              </div>
            </div>
            <i class='bx bx-log-out' id="log_out"></i>
          </li>
        </ul>
      </div>



    </aside>
    <!--=================================== FIM BARRA LATERAL - MENU  =============================================-->


    <!--=================================== COMEÇANDO A PARTE CENTRAL  =============================================-->

    <section class="meio">

      <!-- =========================== criando os três cards =======================================-->

      <div class="regua">

        <div class="item-regua vagas-disponiveis">

          <h2>20%</h2>
          <h3>Percentual de Vagas Disponíveis</h3>


        </div>
        <div class="item-regua2 vagas-ocupadas">

          <h2>22:00</h2>
          <h3>Horário de Menor Fluxo</h3>
        </div>
        <div class="item-regua horario-pico">
          <h2>80%</h2>
          <h3>Percentual de Vagas Ocupadas</h3>
        </div>
      </div>
      <!-- =========================== fim dos cards =======================================-->


      <!-- =========================== criando os gráficos =======================================-->

      <div class="graficos">

        <div class="grafico1">

          <h2>Vagas Ocupadas</h2>
          <canvas id="myChart" style="position: relative; height:40vh; width:40vw; display:flex;"></canvas>
        </div>
        <div class="grafico2">

          <h2>Fluxo de Carros</h2>
          <canvas id="myChart2" style="position: relative; height:40vh; width:40vw; display:flex;"></canvas>
        </div>

        
        <canvas id="canvas_grafico" style="position: relative; height:40vh; width:40vw; display:flex;"></canvas>
      </div>
      </div>

      <!-- =========================== fim dos gráficos =======================================-->

      <!-- =========================== criando o analytics =======================================-->

      <div class="card">

        <div class="titulo">
          <h1>Analytics</h1>
        </div>

        <div class="critico">

          <div class="circulo_red"></div>
          <div class="texto1">
            <h3>Crítico</h3>
          </div>
          <div class="hora">
            <h3>10%</h3>
          </div>

        </div>



        <div class="cuidado">

          <div class="circulo_yellow"></div>
          <div class="texto3">
            <h3>Cuidado</h3>
          </div>
          <div class="hora">
            <h3>20%</h3>
          </div>

        </div>

        <div class="ideal">

          <div class="circulo_green"></div>
          <div class="texto2">
            <h3>Ideal</h3>
          </div>
          <div class="hora">
            <h3>50%</h3>
          </div>

        </div>
        <div class="lotacao">

          <div class="circulo_blue"></div>
          <div class="texto3">
            <h3>Lotação</h3>
          </div>
          <div class="hora">
            <h3>10%</h3>
          </div>

        </div>


      </div>

      <!-- =========================== fim dos analytics  =======================================-->

      <!-- =========================== criando os alertas =======================================-->


      <div class="card2">

        <div class="titulo">
          <h1>Alertas</h1>
        </div>

        <div class="alerta1">

          <div class="texto1">
            <h3>Shopping D </h3>
          </div>
          <div class="numero">
            <h3>+4</h3>
          </div>

        </div>

        <div class="alerta2">

          <div class="texto2">
            <h3>Droga Raia</h3>
          </div>
          <div class="numero">
            <h3>+2</h3>
          </div>

        </div>

        <div class="alerta3">


          <div class="texto3">
            <h3>Extra</h3>
          </div>
          <div class="numero">
            <h3>+1</h3>
          </div>

        </div>


      </div>


      <!-- =========================== fim dos alertas =======================================-->



      <!-- =========================== criando as kpis de fluxo =======================================-->


      <div class="fluxo">
        <div class="titulo">
          <h1>Vagas Disponíveis</h1>
        </div>


        <div class="menor_fluxo">

          <div class="texto2">
            <h3>200 vagas</h3>
          </div>
          <div class="horario">
            <h3>18:00</h3>
          </div>

        </div>

        <div class="maior_fluxo">

          <div class="texto3">
            <h3>30 vagas</h3>
          </div>
          <div class="horario">
            <h3>12:00</h3>
          </div>

        </div>


      </div>


      <!-- =========================== fim das kpis de fluxo =======================================-->




    </section>


    <!--=================================== FIM DA PARTE CENTRAL  =============================================-->




  </main>


  <script>

    const labels2 = [
      'Segunda-feira',
      'Terça-feira',
      'Quarta-feira',
      'Quinta-feira',
      'Sexta-feira',
      'Sábado',
      'Domingo',
    ];

    const data2 = {
      labels: labels2,
      datasets: [{
        label: 'Fluxo de Carros',
        backgroundColor: '#FF4000',
        borderColor: '#FF4000',
        data: [340, 180, 210, 150, 190, 360, 100],

      }]
    };

    const labels = [
      '12:00',
      '12:30',
      '15:00',
      '17:00',
      '13:10',
      '13:40',
    ];

    const data = {
      labels: labels,
      datasets: [{
        label: 'Vagas Ocupadas',
        backgroundColor: '#FF4000',
        borderColor: '#FF4000',
        data: [60, 50, 100, 38, 64, 20],

      }
      ]
    };


    const config = {
      type: 'line',
      data: data,
      options: {


      }
    };
    const config2 = {
      type: 'bar',
      data: data2,
      options: {}
    };


  </script>





  <script>
    const myChart2 = new Chart(
      document.getElementById('myChart2'),
      config2
    );
    const myChart = new Chart(
      document.getElementById('myChart'),
      config
    );

  </script>

  <!-- SCRIPT PARA ABRIR O MENU LATERAL (ta comentado porque não sei se vamos utilizar ele aberto na dashboard) -->

  <script>
    let sidebar = document.querySelector(".sidebar");
    let closeBtn = document.querySelector("#btn");
    let searchBtn = document.querySelector(".bx-search");

    closeBtn.addEventListener("click", () => {
      sidebar.classList.toggle("open");
      menuBtnChange();//calling the function(optional)
    });

    searchBtn.addEventListener("click", () => { // Sidebar open when you click on the search iocn
      sidebar.classList.toggle("open");
      menuBtnChange(); //calling the function(optional)
    });

    // following are the code to change sidebar button(optional)
    function menuBtnChange() {
      if (sidebar.classList.contains("open")) {
        closeBtn.classList.replace("bx-menu", "bx-menu-alt-right");//replacing the iocns class
      } else {
        closeBtn.classList.replace("bx-menu-alt-right", "bx-menu");//replacing the iocns class
      }
    }
  </script>

  <!--================================== SCRIPT DO GRÁFICO ===========================================-->

  <script>
    let proximaAtualizacao;

    window.onload = obterDadosGrafico(1);
    function obterDadosGrafico(idAquario) {

      if (proximaAtualizacao != undefined) {
        clearTimeout(proximaAtualizacao);
      }

      fetch(`/medidas/ultimas/${idAquario}`, { cache: 'no-store' }).then(function (response) {
        if (response.ok) {
          response.json().then(function (resposta) {
            console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
            resposta.reverse();

            plotarGrafico(resposta, idAquario);
          });
        } else {
          console.error('Nenhum dado encontrado ou erro na API');
        }
      })
        .catch(function (error) {
          console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
        });
    }

    // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
    // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
    // A função *plotarGrafico* também invoca a função *atualizarGrafico*
    function plotarGrafico(resposta, idAquario) {
      console.log('iniciando plotagem do gráfico...');

      var dados = {
        labels: [],
        datasets: [
          {
            yAxisID: 'y-chave',
            label: 'Chave',
            borderColor: '#FFF',
            backgroundColor: '#32b9cd8f',
            fill: true,
            data: []
          }
        ]
      };

      for (i = 0; i < resposta.length; i++) {
        var registro = resposta[i];
        dados.labels.push(registro.momento_grafico);
        dados.datasets[0].data.push(registro.chave);
      }

      console.log(JSON.stringify(dados));

      var ctx = canvas_grafico.getContext('2d');
      window.grafico_linha = Chart.Line(ctx, {
        data: dados,
        options: {
          responsive: true,
          animation: { duration: 500 },
          hoverMode: 'index',
          stacked: false,
          title: {
            display: false,
            text: 'Dados capturados'
          },
          scales: {
            yAxes: [
            {
              type: 'linear',
              display: true,
              position: 'left',
              id: 'y-chave',
              ticks: {
                beginAtZero: true,
                max: 50,
                min: 0
            }
            }],
          }
        }
      });

      setTimeout(() => atualizarGrafico(idAquario, dados), 2000);
    }


    // Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
    // buscando a última medida inserida em tabela contendo as capturas, 

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models
    function atualizarGrafico(idAquario, dados) {

      fetch(`/medidas/tempo-real/${idAquario}`, { cache: 'no-store' }).then(function (response) {
        if (response.ok) {
          response.json().then(function (novoRegistro) {

            console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
            console.log(`Dados atuais do gráfico: ${dados}`);

            // tirando e colocando valores no gráfico
            dados.labels.shift(); // apagar o primeiro
            dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

            dados.datasets[0].data.shift();  // apagar o primeiro de temperatura
            dados.datasets[0].data.push(novoRegistro[0].chave); // incluir uma nova medida de temperatura

            window.grafico_linha.update();

            // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
            proximaAtualizacao = setTimeout(() => atualizarGrafico(idAquario, dados), 2000);
          });
        } else {
          console.error('Nenhum dado encontrado ou erro na API');
          // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
          proximaAtualizacao = setTimeout(() => atualizarGrafico(idAquario, dados), 2000);
        }
      })
        .catch(function (error) {
          console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
        });

    }

  </script>


</body>


</html>